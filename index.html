<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Washington State Homeless Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="text/css" href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link type="text/stylesheet" href="css/style.css" rel="stylesheet">
  </head>
  
  <body>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    
    <div class="row-fluid">
      <div class="span12">
        <h1 class="text-center">WA Homeless Chart Prototype</h1>
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12">
        <figure><div class="charts" id="relative-chart">
        </div>
        <figcaption><strong>Washington State Homeless inequality between races, by county.</strong> Bars indicate the ratio of homeless families relative to their proportion of the general population. <br><br><em>Note that this chart is for internal evaluation purposes and data has not yet been verified.</em></figcaption></figure>
      </div>
    </div>
    <div class="row-fluid">
      <div class="span6">
        <div class="charts" id="vert-stack-barchart">
        </div>
      </div>
      <div class="span6">
        <div class="charts" id="barchart-transition">
        </div>
      </div>
    </div>

    <script>
      var margin = {top: 20, right: 40, bottom: 30, left: 0},
          width = 960 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;
          
      var colors = d3.scale.category10();
      
      //var formatAsPercentage = d3.format("%");
          
      var x0 = d3.scale.ordinal()
          .rangeRoundBands([0, width], .25);
          
      var x1 = d3.scale.ordinal();
      
      var y = d3.scale.log()
          .base(2)
          .domain([0.02, 12])
          .range([height, 0])
          .nice();
          
      var xAxis = d3.svg.axis()
          .scale(x0)
          .orient("bottom");
          
      var yAxisLabel = d3.format(",.2f");
          
      var yAxis = d3.svg.axis()
          .scale(y)
          .tickFormat(function(d) { return yAxisLabel(d) + "x"; })
          .orient("right")
          .tickSize(width);
          
      var svg3 = d3.select("#relative-chart").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      
      d3.csv("./data/rel-data-only.csv", function(error, csvdata) {
        var areaName = d3.keys(csvdata[0]).filter(function(key) { return key !== "Area"} );
        
        csvdata.forEach(function(d, i) {
          d.stat = areaName.map(function(name) { 
            return {name: name, value: +d[name]}; 
          })
        });
        
        x0.domain(csvdata.map(function(d) { return d.Area; }));
        x1.domain(areaName).rangeRoundBands([0, x0.rangeBand()]);
        
        var geoGroup = svg3.selectAll(".county")
          .data(csvdata)
          .enter().append("g")
          .attr("class", "g")
          .attr("transform", function(d) {
            return "translate(" + x0(d.Area) + ",0)";
          });
          
        geoGroup.selectAll("rect")
          .data(function(d) { return d.stat; })
          .enter().append("rect")
          .attr("width", x1.rangeBand())
          .attr("x", function(d) { return x1(d.name); })
          .attr("y", function(d) { return y(Math.max(1, d.value)); })
          .attr("height", function(d) { console.log(d.value, y(d.value)); return Math.abs(y(d.value) - y(1)); })
          .style("fill", function(d) { return colors(d.name); });
          
        svg3.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0,0)")
          .call(xAxis);
          
        svg3.append("g")
          .attr("class", "y axis")
          .call(yAxis);

        var legend = svg3.selectAll(".legend")
          .data(areaName.slice())
          .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 18 + ")"; });
          
        legend.append("rect")
          .attr("x", 6)
          .attr("y", height - 110)
          .attr("width", 14)
          .attr("height", 14)
          .style("fill", colors)
          
        legend.append("text")
          .attr("x", 26)
          .attr("y", height - 110)
          .attr("dy", "1em")
          .text(function(d) { return d; });
          
      });

    </script>
  </body>
</html>